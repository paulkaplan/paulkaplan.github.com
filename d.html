<!DOCTYPE html>
<html>
<head>
  <script src="js/dat.gui.js"></script>
  <style>
    html, body { margin: 0; padding: 0;}
    .black { background: black; }
    .white { background: white; }
    #cover { margin:0; padding:0; }
  </style>
</head>

<body>  
</body>
  <div id="cover"></div>
  <script>
  var canvas, s, video, p_ctx, canvasData;
  var x_patch = 0;
  var y_patch = 0;
  var x_size  = 640;
  var y_size  = 480;

  var frequency = Math.random()*100;

  function output_rule(n){
    var rand = Math.random();
    if(rand<0.25){
      return (n+1)%3;
    } else if(rand >0.75) {
      return (n-1)%3;
    } else {
      return n;
    }
  }
  var Settings = function(){
    this.base_probability = 0.05;
    this.energy_scaling   = 0.05;
    this.threshold        = 0.5;
    this.switchFrequency  = 100;
  }
  var settings = new Settings();
  var gui = new dat.GUI();

  gui.add(settings, "base_probability", 0.0, 0.1);
  gui.add(settings, "energy_scaling", 0.0, 0.1);
  gui.add(settings, "threshold", 0.0, 0.99);
  gui.add(settings, "switchFrequency",10, 1000);

  gui.close();

  function startCamera()
  {
    navigator.getMedia = ( navigator.getUserMedia ||
                           navigator.webkitGetUserMedia ||
                           navigator.mozGetUserMedia ||
                           navigator.msGetUserMedia);
    
    navigator.getMedia({ video: true, audio: false }, cameraGranted, cameraDenied);
  }
  var page_canvas;
  function cameraGranted(stream) {
     canvas = document.createElement('canvas')
        canvas.width = 640
        canvas.height = 480;

    ctx = canvas.getContext('2d');
    video = document.createElement('video');
    video.autoplay = true;
    video.src = window.URL.createObjectURL(stream)
    
    // // page_canvas = document.createElement('canvas')
    //     page_canvas.width = window.innerWidth;
    //     page_canvas.height = window.innerHeight;
    //     page_canvas.setAttribute('id', 'page-canvas');
    
    // document.body.appendChild( page_canvas );
    // p_ctx = page_canvas.getContext('2d');
    // canvasData = p_ctx.createImageData(page_canvas.width, page_canvas.height);
     

     
    animate();
  }
  function cameraDenied(error){}
  
  function drawVideo(){
    if (video.readyState === video.HAVE_ENOUGH_DATA){
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
    }
  }
  var frame=0;
  var nextSwitch = frequency;
  function animate(){
    frame++;
    if(frame>frequency){
      doSwitch();
      frame = 0;
      nextSwitch = frequency + Math.random()*50-25;
    } else {
    drawVideo();
    rgb_energy = getEnergy(x_patch, y_patch, x_size, y_size);
    // x_range = [Math.pow(rgb_energy.r, 6), Math.pow(1, 5)].sort();
    // y_range = [Math.pow(rgb_energy.g, 2), Math.pow(rgb_energy.b, 2)].sort();
        // drawMandelbrot();
    var max_n = getMaxEnergy();
        max_n = output_rule(max_n);
        // console.log((0.75-rgb_energy[max_n])*200)

    // drawRectBasedOn( rgb_energy.r, 0 );
    // drawRectBasedOn( rgb_energy.g, 1 );
    // drawRectBasedOn( rgb_energy.b, 2 );
    var prob = settings.base_probability;
    prob += ((rgb_energy[0]+rgb_energy[1]+rgb_energy[2])/3.0) * settings.energy_scaling;
    if( Math.random()*prob > settings.threshold ) { 
      // solidImage(
        // whiteImage();
        setColor('white');
    } else { 
        setColor('black');
    }
    }
            requestAnimFrame(animate, 20);

  }
  function solidImage(index){
    for(var n=0; n<canvasData.data.length; n+=4){
      canvasData.data[n]   = (index === 0 ? 255 : 0);
      canvasData.data[n+1] = (index === 1 ? 255 : 0);
      canvasData.data[n+2] = (index === 2 ? 255 : 0);
      canvasData.data[n+3] = 255;

    }
    p_ctx.putImageData(canvasData, 0, 0)
  }
  function drawNoise(){
    for(var n=0; n<canvasData.data.length; n+=4){
      canvasData.data[n] = rgb_energy.r*255*Math.random();
      canvasData.data[n+1] = rgb_energy.g*255*Math.random();
      canvasData.data[n+2] = rgb_energy.b*255*Math.random();
      canvasData.data[n+3] = 255;

    }
    p_ctx.putImageData(canvasData, 0, 0)
  }
  function drawRectBasedOn(x, n){

    var prob = settings.base_probability;
    prob += x * settings.energy_scaling;
    // p_ctx.clearRect(0, 0, page_canvas.width, page_canvas.height)
    if( Math.random()*prob > settings.threshold ) { 
      // p_ctx.fillStyle = "rgb("+Math.floor(Math.random()*255)+", "+Math.floor(Math.random()*255)+", "+Math.floor(Math.random()*255)+")";
      if(n==0){
        p_ctx.fillStyle = rgbColor( x*255, 0, 0 );
      } else if(n==1){
      p_ctx.fillStyle = rgbColor( 0, x*255, 0 );

      } else {
              p_ctx.fillStyle = rgbColor(  0, 0, x*255);

      }
      rect( Math.random()*window.innerWidth-window.innerWidth/2, Math.random()*window.innerHeight-window.innerHeight/2, 500+Math.random()*500, 500+Math.random()*500);

    } else { 
      // setColor('black');
    }
  }
  function rgbColor(r, g, b){
    return "rgb("+Math.floor(r)+", "+Math.floor(g)+", "+Math.floor(b)+")";
  }
  function rect(x, y, width, height){
    p_ctx.fillRect(Math.floor(x), Math.floor(y), Math.floor(width),Math.floor(height));
  }

  function setColor(color){
    document.body.setAttribute('class', color);
  }
  function getMaxEnergy(){
    var rgb = getEnergy(0, 0, 640, 480);
    var max = rgb.sort()[2];
    if(rgb.r == max){
      return 0;
    } else if(rgb.b == max){
      return 1;
    } else {
      return 2;
    }
  }
  function getEnergy(x, y, w, h){
    // console.log(x, y, w, h)
    var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    var r = 0, g=0, b=0;
    var n=0;
    for(var i=y; i<h+y; i++){
      for(var j=x; j<x+w; j++){
        var index = (j+i*canvas.width)*4;
        r+=imageData.data[index];
        g+=imageData.data[index+1];
        b+=imageData.data[index+2];
        n++;
      }
    }
    r /= n;
    g /= n;
    b /= n;
    return [
       r / 255.0,
       g / 255.0,
       b / 255.0
    ]
  }
    // Mandelbrot
  var x_range = [0, 1], y_range = [0, 1];
  var rgb_energy = {r: 1, g:1, b:1};
  function map(x, range){
    return x * (range[1]-range[0]) + range[0];
  }

  function doSwitch(){
    if(Math.random()>0.75){
      setColor('white');
    }
    // x_patch = 0;
    // y_patch = 0;
    // x_size  = 640;
    // y_size  = 480;
  }
  
  // http://paulirish.com/2011/requestanimationframe-for-smart-animating/
  window.requestAnimFrame = (function(){
    return  function( callback, time ){
              window.setTimeout(callback, time);
            };
  })();

  window.onload = function(){ startCamera(); }

  </script>

</html>