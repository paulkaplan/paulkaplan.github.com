<!DOCTYPE html>
<html>
  <head>
    <title>Webcam, Processing and Websockets</title>
    <meta charset="utf-8" />
    <meta name="description" content="Personal website for Paul Kaplan" />
    <meta name="keywords" content="Paul,Kaplan,UChicago,University of Chicago, personal, interfaces" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   
    <!--[if lte IE 9]><link rel="stylesheet" href="css/ie.css" type="text/css" media="screen" /><![endif]-->
    <link href="//fonts.googleapis.com/css?family=Open+Sans:400,300,600|Merriweather:400,300,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/css/1140.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="/css/styles.css" type="text/css" media="screen"/>
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" media="screen"/>
    <link rel="stylesheet" href="/css/fonts.css" type="text/css" media="screen"/>
    <link rel="stylesheet" href="/css/fancybox.css" type="text/css" media="screen"/>
    
  </head>
  <body>
    <div class="container">
      <div class="row header">
        <div class="fourcol">
          <h1><span class="big">Paul Kaplan</span></h1>
          <h3><span>experimentalist programming</span></h3>
        </div>
        <div class="eightcol last"></div>
      </div>
      <div class="row content">
        

<div class="highlight"><pre><code class="java"><span class="kn">import</span> <span class="nn">hypermedia.video.*</span><span class="o">;</span>  <span class="c1">//  Imports the OpenCV library</span>
<span class="kn">import</span> <span class="nn">java.awt.Rectangle</span><span class="o">;</span>  <span class="c1">//  Strangely isn&#39;t included, has to be imported</span>
<span class="kn">import</span> <span class="nn">org.webbitserver.*</span><span class="o">;</span>  <span class="c1">// P5 Websocket Library for Processing</span>
</code></pre>
</div>




<div class="highlight"><pre><code class="java"><span class="n">WebSocketP5</span> <span class="n">socket</span><span class="o">;</span>
<span class="n">OpenCV</span> <span class="n">opencv</span><span class="o">;</span>
<span class="n">Rectangle</span><span class="o">[]</span> <span class="n">faces</span><span class="o">;</span>          <span class="c1">// We&#39;ll only use one for now, but leave options open</span>
</code></pre>
</div>




<div class="highlight"><pre><code class="java"><span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span>
<span class="o">{</span>
  <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebSocketP5</span><span class="o">(</span><span class="k">this</span><span class="o">,</span><span class="mi">8080</span><span class="o">);</span>

  <span class="n">size</span> <span class="o">(</span> <span class="mi">320</span><span class="o">,</span> <span class="mi">240</span> <span class="o">);</span>
  <span class="n">opencv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OpenCV</span><span class="o">(</span> <span class="k">this</span> <span class="o">);</span>
  <span class="n">opencv</span><span class="o">.</span><span class="na">capture</span><span class="o">(</span> <span class="mi">320</span><span class="o">,</span> <span class="mi">240</span> <span class="o">);</span>
  <span class="n">opencv</span><span class="o">.</span><span class="na">cascade</span><span class="o">(</span> <span class="n">OpenCV</span><span class="o">.</span><span class="na">CASCADE_FRONTALFACE_ALT</span> <span class="o">);</span>
<span class="o">}</span>
</code></pre>
</div>




<div class="highlight"><pre><code class="java"><span class="kt">void</span> <span class="nf">draw</span><span class="o">()</span>
<span class="o">{</span>
  <span class="n">opencv</span><span class="o">.</span><span class="na">read</span><span class="o">();</span> 
  <span class="n">image</span><span class="o">(</span> <span class="n">opencv</span><span class="o">.</span><span class="na">image</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span> <span class="o">);</span>  <span class="c1">//  Draws the camera image to the screen</span>
  <span class="n">opencv</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span> <span class="n">GRAY</span> <span class="o">);</span>
  <span class="n">faces</span> <span class="o">=</span> <span class="n">opencv</span><span class="o">.</span><span class="na">detect</span><span class="o">(</span> <span class="mf">1.2</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">OpenCV</span><span class="o">.</span><span class="na">HAAR_DO_CANNY_PRUNING</span><span class="o">,</span> <span class="mi">40</span><span class="o">,</span> <span class="mi">40</span> <span class="o">);</span>
  <span class="n">noFill</span><span class="o">();</span>
  <span class="n">stroke</span><span class="o">(</span><span class="mi">255</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span>
  
  <span class="c1">// Server side websocket message</span>
  <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">faces</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
    <span class="n">rect</span><span class="o">(</span> <span class="n">faces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">x</span><span class="o">,</span> <span class="n">faces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">y</span><span class="o">,</span> <span class="n">faces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">width</span><span class="o">,</span> <span class="n">faces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">height</span> <span class="o">);</span>
    <span class="n">socket</span><span class="o">.</span><span class="na">broadcast</span><span class="o">(</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span> 
          <span class="k">new</span> <span class="kt">float</span><span class="o">[]</span> <span class="o">{(</span><span class="kt">float</span><span class="o">)(</span><span class="n">faces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">x</span><span class="o">+</span><span class="n">faces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">width</span><span class="o">/</span><span class="mi">2</span><span class="o">)/(</span><span class="mf">320.0</span><span class="o">),</span> 
                       <span class="o">(</span><span class="kt">float</span><span class="o">)(</span><span class="n">faces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">y</span><span class="o">+</span><span class="n">faces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">height</span><span class="o">/</span><span class="mi">2</span><span class="o">)/(</span><span class="mf">240.0</span><span class="o">),</span> 
                       <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="n">faces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">width</span><span class="o">/</span><span class="mf">320.0</span><span class="o">,</span>     <span class="c1">// size of rect determines &#39;zoom&#39;</span>
                       <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="n">faces</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">height</span><span class="o">/</span><span class="mf">240.0</span><span class="o">})</span>
                                      <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;[&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">)</span>
                                      <span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;]&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">)</span>
    <span class="o">);</span>
<span class="o">}</span>
<span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">socket</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span> <span class="c1">// Responsible citizens close their websockets after use</span>
<span class="o">}</span>
</code></pre>
</div>


<h3>THREE.js "WebcamControls"</h3>

<p>TrackballControls, with a very slight modification.</p>

<div class="highlight"><pre><code class="js"><span class="c1">// Declare these instead of the standard mouseX,mouseY</span>
<span class="c1">// They hold the previous face/mouse position</span>
<span class="k">this</span><span class="p">.</span><span class="nx">faceX</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">faceY</span><span class="p">;</span>

<span class="c1">// and the face analog to onMouseMove()</span>
<span class="k">this</span><span class="p">.</span><span class="nx">onFaceMove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">event</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">faceX</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">faceX</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">viewHalfX</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">viewHalfX</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">faceY</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">faceY</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">viewHalfY</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">viewHalfY</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">faceZ</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">faceZ</span> <span class="o">-</span> <span class="mf">0.19</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>  <span class="c1">// Arbitrary scaling that worked</span>
<span class="p">};</span>
</code></pre>
</div>


<h3>Client side websocket</h3>

<div class="highlight"><pre><code class="js"><span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&quot;ws://localhost:8080/p5websocket&quot;</span><span class="p">)</span>

<span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">face</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
  <span class="kd">var</span> <span class="nx">xoff</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">face</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="kd">var</span> <span class="nx">yoff</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">face</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="kd">var</span> <span class="nx">z</span>    <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">face</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
  <span class="nx">controls</span><span class="p">.</span><span class="nx">onFaceMove</span><span class="p">({</span>
    <span class="nx">faceX</span> <span class="o">:</span> <span class="nx">xoff</span><span class="p">,</span>
    <span class="nx">faceY</span> <span class="o">:</span> <span class="nx">yoff</span><span class="p">,</span>
    <span class="nx">faceZ</span> <span class="o">:</span> <span class="nx">z</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre>
</div>




      </div>
    </div>
    <script src="/js/head.js" type="text/javascript"></script>
    <script type="text/javascript">
      head.js(
        { jquery   :   '/js/jquery.js' },
        // { fancybox :   '/js/fancybox.js'},
        { paul     :   '/js/paul.js'   }
        // 
        // 
        //   
        //     ,{ ccv : '/js/posts/20120725/ccv.js' }
        //   
        //     ,{ map : '/js/posts/20120725/map.js' }
        //   
        // 
        //   
        //     ,{ ccv : '/js/posts/20120725/ccv.js' }
        //   
        //     ,{ RAF : '/js/posts/common/requestAnimationFrame.js' }
        //   
        //     ,{ three : '/js/posts/common/three.js' }
        //   
        //     ,{ sine : '/js/posts/20120725/sine.js' }
        //   
        //     ,{ theremin : '/js/posts/20120725/theremin.js' }
        //   
        // 
        //   
        // 
        //   
        // 
        //   
        // 
        //   
        //     ,{ d3 : '/js/d3.js' }
        //   
        //     ,{ three : '/js/three.js' }
        //   
        //     ,{ example : '/js/example.js' }
        //   
        // 
        //   
        // 
        //   
        // 
      );
    </script>
    <script src="/js/mediaqueries.js" type="text/javascript"></script>
  </body>
</html>